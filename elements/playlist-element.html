<!-- Polymer Element -->
<link rel="import" href="/bower_components/polymer/polymer.html">

<!-- Core AJAX -->
<link rel="import" href="/bower_components/core-ajax/core-ajax.html">

<!-- MP3-Playlist Elements -->
<link rel="import" href="/elements/playlist-control-element.html">
<link rel="import" href="/elements/playlist-pager-element.html">
<link rel="import" href="/elements/playlist-track-element.html">

<polymer-element name="playlist-element" attributes="src">
  <template>
    <style>
      .wrapper-playlist {
        display: block;
      }
      .todo {
        width: 584px;
        color: #798795;
        margin-bottom: 20px;
        border-radius: 6px;
      }
      .todo ul {
        background-color: #2c3e50;
        margin: 0;
        padding: 0;
        list-style-type: none;
        border-radius: 6px;
      }
    </style>
    <core-ajax id="ajax" url="{{src}}" handleAs="json" on-core-response="{{handleResponse}}"></core-ajax>
    <audio src="" id="player"></audio>
    <div class="wrapper-playlist">
      <playlist-control-element id="control"></playlist-control-element>
      <div class="playlist-container">
        <playlist-pager-element id="pager"></playlist-pager-element>
        <div class="todo">
          <ul class="js-list" id="tracklist">
            
          </ul>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function(win, doc, undefined){
      Polymer({
        src: "default.json",
        currentTrack: 0,
        trackList: [],
        isPlaying: false,
        isMuted: false,
        ready: function() {
          var that       = this,
              pager      = this.$.pager,
              player     = this.$.player,
              playButton = this.$.control.shadowRoot.querySelector('.js-play-pause'),
              muteButton = this.$.control.shadowRoot.querySelector('.js-mute');

          this.$.ajax.go();
          
          pager.addEventListener('pager-event', function(event){
            that.handlePager(event.detail.type);
          });

          player.addEventListener('play', this.playEvent.bind(this));
          player.addEventListener('pause', this.pauseEvent.bind(this));
          player.addEventListener('ended', this.handlePager.bind(this, 'next'));
          player.addEventListener('timeupdate', this.updateProgress.bind(this));

          playButton.addEventListener('click', this.togglePlay.bind(this));
          muteButton.addEventListener('click', this.toggleMute.bind(this));
        },
        togglePlay: function(e){
          (this.isPlaying) ? this.$.player.pause() : this.$.player.play();
        },
        toggleMute: function(e){
          var muteButton  = this.$.control.shadowRoot.querySelector('.js-mute > span'),
              volume      = (this.isMuted) ? 1.0 : 0.0,
              buttonClass = (this.isMuted) ? 'fui-volume' : 'fui-mute';

          this.isMuted = (this.isMuted) ? false : true;
          this.$.player.volume = volume;
          muteButton.className = buttonClass;
        },
        playEvent: function(e){
          var playButton = this.$.control.shadowRoot.querySelector('.js-play-pause > span');

          this.isPlaying = true;

          playButton.className = 'fui-pause';
        },
        pauseEvent: function(e){
          var playButton = this.$.control.shadowRoot.querySelector('.js-play-pause > span');

          this.isPlaying = false;
          playButton.className = 'fui-play';
        },
        handleResponse: function(data){
          this.trackList = data.detail.response;
          this.createPlaylist();
        },
        handlePager: function(direction){
          var newCurrent = (direction == 'next') ? this.currentTrack + 1 : this.currentTrack - 1;

          if(this.currentTrack == 0 && direction == 'previous'){
            newCurrent = (this.trackList.length - 1);
          }

          if(this.currentTrack == (this.trackList.length - 1) && direction == 'next'){
            newCurrent = 0;
          }

          this.setTrack(newCurrent);
        },
        createPlaylist: function(){
          var that = this,
              tempElmnt;

          this.trackList.map(function(track, index){
            tempElmnt = doc.createElement('playlist-track-element');

            tempElmnt.setAttribute('song', track.artist + ' - ' + track.title);
            tempElmnt.setAttribute('index', index);

            tempElmnt.addEventListener('track-event', function(event){
              var trackIndex = event.detail.index;
              that.setTrack(trackIndex);
            });

            that.$.tracklist.appendChild(tempElmnt);
          });

          this.setTrack(0);
        },
        updateProgress: function(e){
          var current  = Math.round(this.$.player.currentTime),
            duration = Math.round(this.$.player.duration),
            percentage;

          percentage = ((current / duration) * 100);
          this.$.control.setAttribute('progress', percentage);
        },
        setTrack: function(index){
          var track = this.trackList[index],
              trackDom = this.$.tracklist,
              trackElements = trackDom.querySelectorAll('playlist-track-element'),
              trackLI = trackElements[index].shadowRoot.querySelector('li');

          this.currentTrack = index;

          [].slice.call(trackElements).map(function(element){
            element.shadowRoot.querySelector('li').classList.remove('todo-done');
          });

          trackLI.classList.add('todo-done');

          this.$.pager.setAttribute('currentTrack', track.artist + ' - ' + track.title);

          this.$.player.setAttribute('src', track.file);
          this.$.player.load();
          this.$.player.play();
        }
      })
    })(window, document);
  </script>
</polymer-element>